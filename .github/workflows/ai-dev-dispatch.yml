name: AI Dev Auto-Dispatch

on:
  issues:
    types: [labeled]

jobs:
  dispatch-to-dev:
    # handoff:pmâ†’dev ë¼ë²¨ì´ ë¶™ì€ ì´ìŠˆë§Œ ì²˜ë¦¬
    if: github.event.label.name == 'handoff:pmâ†’dev'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue info
        id: issue
        run: |
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify Slack - Dev Started
        if: ${{ vars.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {
                  "type": "header",
                  "text": {"type": "plain_text", "text": "ğŸ¤– AI Dev ì‘ì—… ì‹œì‘", "emoji": true}
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*ì´ìŠˆ:*\n#${{ steps.issue.outputs.issue_number }} ${{ github.event.issue.title }}"},
                    {"type": "mrkdwn", "text": "*íŠ¸ë¦¬ê±°:*\nhandoff:pmâ†’dev"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "ğŸ“‹ ì´ìŠˆ ë³´ê¸°"},
                      "url": "${{ github.event.issue.html_url }}"
                    }
                  ]
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL

      # Claude Code ì‹¤í–‰ (GitHub Actionsì—ì„œ Claude Code ì‚¬ìš©)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Dev Cycle
        id: dev_cycle
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # ì´ìŠˆ ì •ë³´ë¥¼ íŒŒì¼ë¡œ ì €ì¥
          cat > /tmp/issue-context.md << 'ISSUE_EOF'
          # Issue #${{ steps.issue.outputs.issue_number }}: ${{ github.event.issue.title }}

          ${{ github.event.issue.body }}
          ISSUE_EOF

          # Claude Code ì‹¤í–‰ (ë¹„ëŒ€í™”í˜• ëª¨ë“œ)
          claude -p "
          ë‹¹ì‹ ì€ AI Devì…ë‹ˆë‹¤. ë‹¤ìŒ ì´ìŠˆë¥¼ ì²˜ë¦¬í•˜ì„¸ìš”:

          $(cat /tmp/issue-context.md)

          ì‘ì—… ìˆœì„œ:
          1. ì´ìŠˆ ë‚´ìš© ë¶„ì„
          2. í•„ìš”í•œ ì½”ë“œ ë³€ê²½ ìˆ˜í–‰
          3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (npm run build)
          4. ë³€ê²½ì‚¬í•­ ì»¤ë°‹

          ì™„ë£Œ í›„ ê²°ê³¼ë¥¼ ìš”ì•½í•´ì£¼ì„¸ìš”.
          " --output-format json > /tmp/result.json 2>&1 || true

          echo "result_file=/tmp/result.json" >> $GITHUB_OUTPUT

      - name: Create branch and commit
        run: |
          BRANCH_NAME="ai-dev/issue-${{ steps.issue.outputs.issue_number }}"
          git config user.name "AI Dev Bot"
          git config user.email "ai-dev@tinysolver.org"

          # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì»¤ë°‹
          if [[ -n $(git status --porcelain) ]]; then
            git checkout -b "$BRANCH_NAME"
            git add -A
            git commit -m "fix(#${{ steps.issue.outputs.issue_number }}): ${{ github.event.issue.title }}"
            git push origin "$BRANCH_NAME"
            echo "BRANCH_CREATED=true" >> $GITHUB_ENV
            echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          else
            echo "BRANCH_CREATED=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: env.BRANCH_CREATED == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "fix(#${{ steps.issue.outputs.issue_number }}): ${{ github.event.issue.title }}" \
            --body "## ìë™ ìƒì„±ëœ PR

          ê´€ë ¨ ì´ìŠˆ: #${{ steps.issue.outputs.issue_number }}

          ### AI Dev ì‘ì—… ê²°ê³¼
          ì´ PRì€ AI Devì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

          ### ì²´í¬ë¦¬ìŠ¤íŠ¸
          - [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
          - [ ] í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
          - [ ] Human ìŠ¹ì¸
          " \
            --label "ai-generated"

      - name: Comment on issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "$BRANCH_CREATED" == "true" ]]; then
            gh issue comment ${{ steps.issue.outputs.issue_number }} \
              --body "## ğŸ¤– AI Dev ì‘ì—… ì™„ë£Œ

          PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${{ env.BRANCH_NAME }}

          ### ë‹¤ìŒ ë‹¨ê³„
          - [ ] PR ë¦¬ë·°
          - [ ] ë¨¸ì§€ ìŠ¹ì¸"
          else
            gh issue comment ${{ steps.issue.outputs.issue_number }} \
              --body "## ğŸ¤– AI Dev ë¶„ì„ ì™„ë£Œ

          ì´ìŠˆë¥¼ ë¶„ì„í–ˆì§€ë§Œ ì½”ë“œ ë³€ê²½ì´ í•„ìš”í•˜ì§€ ì•Šê±°ë‚˜, ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.

          ìƒì„¸ ë‚´ìš©ì€ Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
          fi

      - name: Notify Slack - Dev Completed
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="ì™„ë£Œ"
            if [ "${{ job.status }}" != "success" ]; then
              STATUS_EMOJI="âŒ"
              STATUS_TEXT="ì‹¤íŒ¨"
            fi

            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"blocks\": [
                  {
                    \"type\": \"header\",
                    \"text\": {\"type\": \"plain_text\", \"text\": \"$STATUS_EMOJI AI Dev ì‘ì—… $STATUS_TEXT\", \"emoji\": true}
                  },
                  {
                    \"type\": \"section\",
                    \"fields\": [
                      {\"type\": \"mrkdwn\", \"text\": \"*ì´ìŠˆ:*\n#${{ steps.issue.outputs.issue_number }}\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*ë¸Œëœì¹˜:*\n${BRANCH_NAME:-ì—†ìŒ}\"}
                    ]
                  },
                  {
                    \"type\": \"actions\",
                    \"elements\": [
                      {
                        \"type\": \"button\",
                        \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ“‹ ì´ìŠˆ\"},
                        \"url\": \"${{ github.event.issue.html_url }}\"
                      },
                      {
                        \"type\": \"button\",
                        \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ” Actions ë¡œê·¸\"},
                        \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                      }
                    ]
                  }
                ]
              }" \
              $SLACK_WEBHOOK_URL
          fi
